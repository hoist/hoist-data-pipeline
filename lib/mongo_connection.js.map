{"version":3,"sources":["mongo_connection.js"],"names":[],"mappings":"AAAA,YAAY,CAAC;;;;;;;;;AACb,IAAI,SAAS,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC;AACpC,IAAI,OAAO,GAAG,OAAO,CAAC,SAAS,CAAC,CAAC;AACjC,IAAI,MAAM,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC;AAC/B,IAAI,MAAM,GAAG,OAAO,CAAC,eAAe,CAAC,CAAC;AACtC,SAAS,CAAC,YAAY,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;;;;;IAItC,eAAe;;;;;AAIR,WAJP,eAAe,GAIL;0BAJV,eAAe;;AAKjB,QAAI,CAAC,YAAY,GAAG,OAAO,CAAC,WAAW,CAAC;AACxC,QAAI,CAAC,OAAO,GAAG,MAAM,CAAC,KAAK,CAAC;AAC1B,SAAG,EAAE,IAAI,CAAC,WAAW,CAAC,IAAI;KAC3B,CAAC,CAAC;GACJ;;eATG,eAAe;;WAYN,yBAAG;AACd,UAAI,IAAI,CAAC,kBAAkB,EAAE;AAC3B,YAAI,CAAC,OAAO,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;AACtC,oBAAY,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;OACvC;KACF;;;WACY,yBAAG;;;AACd,UAAI,IAAI,CAAC,kBAAkB,EAAE;AAC3B,YAAI,CAAC,OAAO,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;AACtC,oBAAY,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;OACvC;AACD,UAAI,CAAC,kBAAkB,GAAG,UAAU,CAAC,YAAM;AACzC,cAAK,WAAW,CAAC,UAAU,EAAE,CAAC;AAC9B,eAAO,MAAK,WAAW,CAAC;OACzB,EAAE,IAAI,CAAC,CAAC;KACV;;;WACc,2BAAG;;;AAChB,UAAI,CAAC,aAAa,EAAE,CAAC;AACrB,aAAO,IAAI,CAAC,YAAY,CACrB,YAAY,CAAC,MAAM,CAAC,GAAG,CAAC,0BAA0B,CAAC,CAAC,CACpD,IAAI,CAAC,UAAC,UAAU,EAAK;;AAEpB,eAAK,aAAa,EAAE,CAAC;AACrB,eAAK,OAAO,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC;AACvC,eAAK,WAAW,GAAG,UAAU,CAAC;AAC9B,eAAO,UAAU,CAAC;OACnB,CAAC,CAAC;KACN;;;;;;;;WAMI,iBAAG;AACN,UAAI,CAAC,IAAI,CAAC,WAAW,EAAE;AACrB,eAAO,OAAO,CAAC,OAAO,EAAE,CAAC;OAC1B;AACD,UAAI,CAAC,aAAa,EAAE,CAAC;AACrB,UAAI,UAAU,GAAG,IAAI,CAAC,WAAW,CAAC;AAClC,aAAO,IAAI,CAAC,WAAW,CAAC;AACxB,aAAO,UAAU,CAAC,UAAU,EAAE,CAAC;KAChC;;;;;;;;WAMG,gBAAG;AACL,UAAI,IAAI,CAAC,WAAW,EAAE;AACpB,YAAI,CAAC,aAAa,EAAE,CAAC;AACrB,eAAO,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;OAC1C,MAAM;AACL,eAAO,IAAI,CAAC,eAAe,EAAE,CAAC;OAC/B;KAEF;;;SAnEG,eAAe;;;qBAsEN,eAAe","file":"mongo_connection.js","sourcesContent":["'use strict';\nvar BBPromise = require('bluebird');\nvar mongodb = require('mongodb');\nvar config = require('config');\nvar logger = require('@hoist/logger');\nBBPromise.promisifyAll(mongodb.MongoClient);\n/**\n * marshalling class for connection to mongodb\n */\nclass MongoConnection {\n  /**\n   * create a new instance\n   */\n  constructor() {\n    this._mongoClient = mongodb.MongoClient;\n    this._logger = logger.child({\n      cls: this.constructor.name\n    });\n  }\n\n\n  _clearTimeout() {\n    if (this._connectionTimeout) {\n      this._logger.info('clearing timeout');\n      clearTimeout(this._connectionTimeout);\n    }\n  }\n  _resetTimeout() {\n    if (this._connectionTimeout) {\n      this._logger.info('clearing timeout');\n      clearTimeout(this._connectionTimeout);\n    }\n    this._connectionTimeout = setTimeout(() => {\n      this._connection.closeAsync();\n      delete this._connection;\n    }, 2000);\n  }\n  _openConnection() {\n    this._clearTimeout();\n    return this._mongoClient\n      .connectAsync(config.get('Hoist.mongo.applications'))\n      .then((connection) => {\n        //close connection after 2 seconds of inactivity\n        this._resetTimeout();\n        this._logger.info('connection opened');\n        this._connection = connection;\n        return connection;\n      });\n  }\n\n  /**\n   * close any open connection to mongo\n   * @returns {Promise}\n   */\n  close() {\n    if (!this._connection) {\n      return Promise.resolve();\n    }\n    this._clearTimeout();\n    let connection = this._connection;\n    delete this._connection;\n    return connection.closeAsync();\n  }\n\n  /**\n   * Attempt to reuse mongo connection or open one if it doesn't exist\n   * @returns {Promise}\n   */\n  open() {\n    if (this._connection) {\n      this._resetTimeout();\n      return Promise.resolve(this._connection);\n    } else {\n      return this._openConnection();\n    }\n\n  }\n}\n\nexport default MongoConnection;\n"],"sourceRoot":"/source/"}