{"version":3,"sources":["mongo_connection.js"],"names":[],"mappings":"AAAA,YAAY,CAAC;;;;;;;;;;;wBACQ,UAAU;;;;uBACX,SAAS;;;;sBACV,QAAQ;;;;2BACR,eAAe;;;;AAClC,sBAAS,YAAY,CAAC,qBAAQ,WAAW,CAAC,CAAC;;;;;IAIrC,eAAe;;;;;AAIR,WAJP,eAAe,GAIL;0BAJV,eAAe;;AAKjB,QAAI,CAAC,YAAY,GAAG,qBAAQ,WAAW,CAAC;AACxC,QAAI,CAAC,OAAO,GAAG,yBAAO,KAAK,CAAC;AAC1B,SAAG,EAAE,IAAI,CAAC,WAAW,CAAC,IAAI;KAC3B,CAAC,CAAC;GACJ;;eATG,eAAe;;WAYN,yBAAG;AACd,UAAI,IAAI,CAAC,kBAAkB,EAAE;AAC3B,YAAI,CAAC,OAAO,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;AACtC,oBAAY,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;OACvC;KACF;;;WACY,yBAAG;;;AACd,UAAI,IAAI,CAAC,kBAAkB,EAAE;AAC3B,YAAI,CAAC,OAAO,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;AACtC,oBAAY,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;OACvC;AACD,UAAI,CAAC,kBAAkB,GAAG,UAAU,CAAC,YAAM;AACzC,YAAI,MAAK,WAAW,EAAE;AACpB,gBAAK,WAAW,CAAC,UAAU,EAAE,CAAC;AAC9B,iBAAO,MAAK,WAAW,CAAC;SACzB;OACF,EAAE,IAAI,CAAC,CAAC;KACV;;;WACc,2BAAG;;;AAChB,UAAI,CAAC,aAAa,EAAE,CAAC;AACrB,aAAO,IAAI,CAAC,YAAY,CACrB,YAAY,CAAC,oBAAO,GAAG,CAAC,0BAA0B,CAAC,CAAC,CACpD,IAAI,CAAC,UAAC,UAAU,EAAK;;AAEpB,eAAK,aAAa,EAAE,CAAC;AACrB,eAAK,OAAO,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC;AACvC,eAAK,WAAW,GAAG,UAAU,CAAC;AAC9B,8BAAS,YAAY,CAAC,OAAK,WAAW,CAAC,CAAC;AACxC,eAAO,UAAU,CAAC;OACnB,CAAC,CAAC;KACN;;;;;;;;WAMI,iBAAG;AACN,UAAI,CAAC,IAAI,CAAC,WAAW,EAAE;AACrB,eAAO,OAAO,CAAC,OAAO,EAAE,CAAC;OAC1B;AACD,UAAI,CAAC,aAAa,EAAE,CAAC;AACrB,UAAI,UAAU,GAAG,IAAI,CAAC,WAAW,CAAC;AAClC,aAAO,IAAI,CAAC,WAAW,CAAC;AACxB,aAAO,UAAU,CAAC,UAAU,EAAE,CAAC;KAChC;;;;;;;;WAMG,gBAAG;AACL,UAAI,IAAI,CAAC,WAAW,EAAE;AACpB,YAAI,CAAC,aAAa,EAAE,CAAC;AACrB,eAAO,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;OAC1C,MAAM;AACL,eAAO,IAAI,CAAC,eAAe,EAAE,CAAC;OAC/B;KAEF;;;SAtEG,eAAe;;;qBAyEN,eAAe","file":"mongo_connection.js","sourcesContent":["'use strict';\nimport Bluebird from 'bluebird';\nimport mongodb from 'mongodb';\nimport config from 'config';\nimport logger from '@hoist/logger';\nBluebird.promisifyAll(mongodb.MongoClient);\n/**\n * marshalling class for connection to mongodb\n */\nclass MongoConnection {\n  /**\n   * create a new instance\n   */\n  constructor() {\n    this._mongoClient = mongodb.MongoClient;\n    this._logger = logger.child({\n      cls: this.constructor.name\n    });\n  }\n\n\n  _clearTimeout() {\n    if (this._connectionTimeout) {\n      this._logger.info('clearing timeout');\n      clearTimeout(this._connectionTimeout);\n    }\n  }\n  _resetTimeout() {\n    if (this._connectionTimeout) {\n      this._logger.info('clearing timeout');\n      clearTimeout(this._connectionTimeout);\n    }\n    this._connectionTimeout = setTimeout(() => {\n      if (this._connection) {\n        this._connection.closeAsync();\n        delete this._connection;\n      }\n    }, 2000);\n  }\n  _openConnection() {\n    this._clearTimeout();\n    return this._mongoClient\n      .connectAsync(config.get('Hoist.mongo.applications'))\n      .then((connection) => {\n        //close connection after 2 seconds of inactivity\n        this._resetTimeout();\n        this._logger.info('connection opened');\n        this._connection = connection;\n        Bluebird.promisifyAll(this._connection);\n        return connection;\n      });\n  }\n\n  /**\n   * close any open connection to mongo\n   * @returns {Promise}\n   */\n  close() {\n    if (!this._connection) {\n      return Promise.resolve();\n    }\n    this._clearTimeout();\n    let connection = this._connection;\n    delete this._connection;\n    return connection.closeAsync();\n  }\n\n  /**\n   * Attempt to reuse mongo connection or open one if it doesn't exist\n   * @returns {Promise}\n   */\n  open() {\n    if (this._connection) {\n      this._resetTimeout();\n      return Promise.resolve(this._connection);\n    } else {\n      return this._openConnection();\n    }\n\n  }\n}\n\nexport default MongoConnection;\n"],"sourceRoot":"/source/"}